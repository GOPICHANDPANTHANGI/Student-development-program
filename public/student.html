<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Portal • SDP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; } .bg-app { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); } </style>
  </head>
  <body class="min-h-screen bg-app text-slate-100">
    <div class="max-w-7xl mx-auto px-6 py-8">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-semibold" id="greeting">Student Portal</h1>
        <div class="flex items-center gap-3 text-sm">
          <a href="analytics.html" class="hover:text-orange-300">Analytics</a>
          <button id="btn-logout" class="px-3 py-1 rounded bg-white/10 border border-white/20">Logout</button>
        </div>
      </div>

      <section class="mt-6 grid md:grid-cols-3 gap-4">
        <div class="bg-white/10 rounded-xl p-4">
          <p class="text-white/70 text-sm">My Enrollments</p>
          <p id="stat-enrolled" class="text-2xl font-bold">0</p>
        </div>
        <div class="bg-white/10 rounded-xl p-4">
          <p class="text-white/70 text-sm">Available SDPs</p>
          <p id="stat-available" class="text-2xl font-bold">0</p>
        </div>
        <div class="bg-white/10 rounded-xl p-4">
          <p class="text-white/70 text-sm">My Feedback</p>
          <p id="stat-feedback" class="text-2xl font-bold">0</p>
        </div>
      </section>

      <section class="mt-8 grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 bg-white/10 rounded-2xl p-6 border border-white/10">
          <h2 class="text-xl font-semibold">Upcoming & Ongoing Programs</h2>
          <div id="list-programs" class="mt-4 grid md:grid-cols-2 gap-4"></div>
        </div>
        <div class="bg-white/10 rounded-2xl p-6 border border-white/10">
          <h2 class="text-xl font-semibold">Vote Topics</h2>
          <div id="list-votes" class="mt-3 grid gap-3"></div>
        </div>
      </section>

      <section class="mt-8 bg-white/10 rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-semibold">Give Feedback</h2>
        <form id="form-feedback" class="mt-4 grid md:grid-cols-4 gap-3">
          <select id="fb-program" class="px-3 py-2 rounded bg-white/10 border border-white/20 md:col-span-2"></select>
          <select id="fb-rating" class="px-3 py-2 rounded bg-white text-slate-900 border border-white/20">
            <option value="5">★★★★★</option>
            <option value="4">★★★★☆</option>
            <option value="3">★★★☆☆</option>
            <option value="2">★★☆☆☆</option>
            <option value="1">★☆☆☆☆</option>
          </select>
          <input id="fb-comment" placeholder="Your feedback" class="px-3 py-2 rounded bg-white/10 border border-white/20 md:col-span-2" />
          <button class="px-3 py-2 rounded bg-teal-300 text-slate-900 font-semibold">Submit</button>
        </form>
      </section>

      <section class="mt-8 bg-white/10 rounded-2xl p-6 border border-white/10">
        <h2 class="text-xl font-semibold">Suggestion Box</h2>
        <form id="form-suggest" class="mt-4 grid md:grid-cols-4 gap-3">
          <input id="sg-text" placeholder="Share your idea (topic, workshop, etc.)" class="px-3 py-2 rounded bg-white text-slate-900 border border-white/20 md:col-span-3" />
          <button class="px-3 py-2 rounded bg-orange-400 text-slate-900 font-semibold">Send</button>
        </form>
      </section>
    </div>

    <script src="./js/store.js"></script>
    <script>
      if (!Store.requireRole('student')) { window.location.href = 'auth-student.html'; }
      const elPrograms = document.getElementById('list-programs');
      const elVotes = document.getElementById('list-votes');
      const btnLogout = document.getElementById('btn-logout');

      function refreshStats() {
        const me = Store.me();
        const id = me.roll || me.email;
        const enrolled = Store.myEnrollments(id).length;
        const available = Store.listPrograms(['upcoming','ongoing']).length;
        const myFb = Store.listFeedback().filter(f => (f.student_roll||f.student_email) === id).length;
        document.getElementById('stat-enrolled').textContent = enrolled;
        document.getElementById('stat-available').textContent = available;
        document.getElementById('stat-feedback').textContent = myFb;
      }

      async function renderPrograms() {
        const me = Store.me();
        const id = me.roll || me.email;
        const items = Store.useSupabase() 
          ? await Store.listProgramsSupabase(['upcoming','ongoing'])
          : Store.listPrograms(['upcoming','ongoing']);
        elPrograms.innerHTML = '';
        items.forEach(p => {
          const isEnrolled = p.participants.includes(id);
          const card = document.createElement('div');
          card.className = 'rounded-xl bg-white/10 border border-white/10 p-4';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div>
                <h3 class="font-semibold">${p.title}</h3>
                <p class="text-sm text-white/70">${p.category} • ${p.status}</p>
              </div>
              <div class="text-right text-sm text-white/80">
                <div>Capacity: ${p.capacity}</div>
                <div>Registered: ${p.participants.length}</div>
              </div>
            </div>
            <p class="mt-2 text-sm text-white/80 line-clamp-2">${p.description || ''}</p>
            <div class="mt-3">
              ${isEnrolled ? `<button data-id="${p.id}" class="btn-unenroll px-3 py-1 rounded bg-white/10 border border-white/20 text-sm">Unenroll</button>` : `<button data-id="${p.id}" class="btn-enroll px-3 py-1 rounded bg-teal-300 text-slate-900 text-sm font-semibold">Enroll</button>`}
            </div>
          `;
          elPrograms.appendChild(card);
        });
      }

      async function renderVotes() {
        const items = Store.useSupabase() 
          ? await Store.listVotesSupabase()
          : Store.listVotes();
        elVotes.innerHTML = '';
        const open = Store.isVotingOpen();
        items.forEach(v => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between bg-white/10 border border-white/10 rounded px-3 py-2';
          row.innerHTML = `
            <div>
              <div class="font-medium">${v.topic_title}</div>
              <div class="text-xs text-white/70">${v.category}</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm">${v.votes} votes</span>
              ${open ? `<button data-id="${v.id}" class="btn-inc px-2 py-1 rounded bg-orange-400 text-slate-900 text-sm font-semibold">Vote</button>` : `<span class="text-xs text-white/70">Voting closed</span>`}
            </div>
          `;
          elVotes.appendChild(row);
        });
      }

      elPrograms.addEventListener('click', async (e) => {
        const t = e.target;
        const me = Store.me();
        const id = me.roll || me.email;
        if (t.classList.contains('btn-enroll')) { 
          if (Store.useSupabase()) {
            await Store.enrollSupabase(id, t.getAttribute('data-id'));
          } else {
            Store.enroll(id, t.getAttribute('data-id'));
          }
          await renderPrograms(); 
          refreshStats(); 
          fillFeedbackPrograms(); 
        }
        if (t.classList.contains('btn-unenroll')) { 
          if (Store.useSupabase()) {
            await Store.unenrollSupabase(id, t.getAttribute('data-id'));
          } else {
            Store.unenroll(id, t.getAttribute('data-id'));
          }
          await renderPrograms(); 
          refreshStats(); 
          fillFeedbackPrograms(); 
        }
      });

      elVotes.addEventListener('click', async (e) => {
        const t = e.target;
        if (t.classList.contains('btn-inc')) {
          const ok = Store.useSupabase() 
            ? await Store.incrementVoteSupabase(t.getAttribute('data-id'))
            : Store.incrementVote(t.getAttribute('data-id'));
          if (!ok) alert('You can only vote once per topic.');
          await renderVotes();
        }
      });

      btnLogout.addEventListener('click', () => { Store.logout(); window.location.href = 'index.html'; });

      function fillFeedbackPrograms() {
        const me = Store.me();
        const id = me.roll || me.email;
        const select = document.getElementById('fb-program');
        const my = Store.myEnrollments(id);
        select.innerHTML = '';
        my.forEach(p => {
          const o = document.createElement('option');
          o.value = p.id; o.textContent = p.title; select.appendChild(o);
        });
      }

      document.getElementById('form-feedback').addEventListener('submit', async (e) => {
        e.preventDefault();
        const me = Store.me();
        const id = me.roll || me.email;
        const payload = {
          program_id: document.getElementById('fb-program').value,
          student_roll: id,
          student_name: me.name || id,
          rating: parseInt(document.getElementById('fb-rating').value, 10),
          comment: document.getElementById('fb-comment').value.trim()
        };
        if (!payload.program_id) return;
        
        if (Store.useSupabase()) {
          await Store.addFeedbackSupabase(payload);
        } else {
          Store.addFeedback(payload);
        }
        
        e.target.reset();
        refreshStats();
        alert('Thanks for your feedback!');
      });

      document.getElementById('form-suggest').addEventListener('submit', async (e) => {
        e.preventDefault();
        const me = Store.me();
        const text = document.getElementById('sg-text').value.trim();
        if (!text) return;
        
        if (Store.useSupabase()) {
          await Store.addSuggestionSupabase({ roll: me.roll || me.email, name: me.name || (me.roll||''), text });
        } else {
          Store.addSuggestion({ roll: me.roll || me.email, name: me.name || (me.roll||''), text });
        }
        
        e.target.reset();
        alert('Suggestion submitted!');
      });

      // Initialize the page
      async function init() {
        const me = Store.me();
        if (me && (me.name || me.roll)) {
          const g = document.getElementById('greeting');
          g.textContent = `Hello, ${me.name || me.roll}`;
        }
        refreshStats();
        await renderPrograms();
        await renderVotes();
        fillFeedbackPrograms();
      }

      // Auto-refresh when another tab updates localStorage (same origin)
      window.addEventListener('storage', async (e) => {
        if (!e) return;
        refreshStats();
        await renderPrograms();
        await renderVotes();
        fillFeedbackPrograms();
      });

      // Start the application
      init();
    </script>
  </body>
</html>


